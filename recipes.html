<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Рецепты</title>
    <style>
        * { box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            margin: 0;
            padding: 1.5rem;
            background: #f5f0ea;
            color: #2c2416;
        }
        h1 {
            text-align: center;
            margin-bottom: 1.5rem;
            color: #5c4a32;
        }
        .tabs {
            display: flex;
            gap: 0;
            max-width: 1200px;
            margin: 0 auto 1.25rem;
            border-bottom: 2px solid #e8e0d5;
        }
        .tabs button {
            padding: 0.65rem 1.5rem;
            font-size: 1rem;
            font-family: inherit;
            color: #6b5d4d;
            background: transparent;
            border: none;
            border-bottom: 3px solid transparent;
            margin-bottom: -2px;
            cursor: pointer;
            transition: color 0.2s, border-color 0.2s;
        }
        .tabs button:hover {
            color: #5c4a32;
        }
        .tabs button.active {
            color: #5c4a32;
            font-weight: 600;
            border-bottom-color: #5c4a32;
        }
        .search-wrap {
            max-width: 1200px;
            margin: 0 auto 1rem;
        }
        .search-wrap input {
            width: 100%;
            padding: 0.65rem 1rem;
            font-size: 1rem;
            font-family: inherit;
            color: #2c2416;
            background: #fff;
            border: 1px solid #ddd5c8;
            border-radius: 8px;
            outline: none;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .search-wrap input:focus {
            border-color: #5c4a32;
            box-shadow: 0 0 0 2px rgba(92, 74, 50, 0.15);
        }
        .search-wrap input::placeholder {
            color: #999;
        }
        .tag-filters {
            max-width: 1200px;
            margin: 0 auto 1rem;
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 0.5rem;
        }
        .tag-filters .label {
            font-size: 0.9rem;
            color: #6b5d4d;
            margin-right: 0.25rem;
        }
        .tag-filters button {
            padding: 0.4rem 0.75rem;
            font-size: 0.85rem;
            font-family: inherit;
            color: #5c4a32;
            background: #e8e0d5;
            border: 1px solid #ddd5c8;
            border-radius: 6px;
            cursor: pointer;
            transition: background 0.2s, border-color 0.2s;
        }
        .tag-filters button:hover {
            background: #ddd5c8;
        }
        .tag-filters button.active {
            background: #5c4a32;
            color: #fff;
            border-color: #5c4a32;
        }
        .tab-panel {
            display: none;
        }
        .tab-panel.active {
            display: block;
        }
        #loading {
            text-align: center;
            padding: 2rem;
            color: #666;
        }
        #error {
            color: #b33;
            padding: 1rem;
            text-align: center;
        }
        .recipes {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 1.25rem;
            max-width: 1200px;
            margin: 0 auto;
        }
        .recipe-card {
            background: #fff;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            transition: box-shadow 0.2s;
        }
        .recipe-card:hover {
            box-shadow: 0 4px 16px rgba(0,0,0,0.12);
        }
        .recipe-card .img-wrap {
            overflow: hidden;
        }
        .recipe-card img {
            width: 100%;
            height: 180px;
            object-fit: cover;
            display: block;
        }
        .recipe-card .body {
            padding: 1rem;
        }
        .recipe-card h2 {
            margin: 0 0 0.5rem;
            font-size: 1.1rem;
            line-height: 1.3;
            color: #3d3428;
        }
        .recipe-card .meta {
            font-size: 0.85rem;
            color: #6b5d4d;
            margin-bottom: 0.5rem;
        }
        .recipe-card .description {
            font-size: 0.9rem;
            color: #555;
            line-height: 1.4;
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        .recipe-card .tags {
            margin-top: 0.75rem;
            display: flex;
            flex-wrap: wrap;
            gap: 0.35rem;
        }
        .recipe-card .tag {
            font-size: 0.75rem;
            background: #e8e0d5;
            color: #5c4a32;
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
        }
        .recipe-card .card-actions {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-top: 0.75rem;
            padding-top: 0.75rem;
            border-top: 1px solid #e8e0d5;
        }
        .recipe-card .card-actions .btn-icon {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: 1px solid #ddd5c8;
            background: #fff;
            color: #5c4a32;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s, border-color 0.2s;
            flex-shrink: 0;
        }
        .recipe-card .card-actions .btn-icon:hover {
            background: #e8e0d5;
            border-color: #c9bfb0;
        }
        .recipe-card .card-actions .btn-icon svg {
            width: 16px;
            height: 16px;
        }
        .recipe-card .card-actions a.btn-icon {
            text-decoration: none;
        }
        .tabs .cart-badge {
            display: inline-block;
            min-width: 1.25em;
            padding: 0.15em 0.4em;
            margin-left: 0.35rem;
            font-size: 0.8em;
            font-weight: 600;
            color: #fff;
            background: #5c4a32;
            border-radius: 10px;
            vertical-align: middle;
        }
        .cart-empty {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
            text-align: center;
            color: #6b5d4d;
            background: #fff;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        .popup-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.4);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }
        .popup-overlay.active {
            display: flex;
        }
        .popup {
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.2);
            max-width: 420px;
            width: 100%;
            max-height: 85vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        .popup-header {
            padding: 1rem 1.25rem;
            border-bottom: 1px solid #e8e0d5;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-shrink: 0;
        }
        .popup-header h3 {
            margin: 0;
            font-size: 1.1rem;
            color: #3d3428;
        }
        .popup-close {
            width: 32px;
            height: 32px;
            border: none;
            background: transparent;
            color: #6b5d4d;
            cursor: pointer;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
        }
        .popup-close:hover {
            background: #e8e0d5;
        }
        .popup-close svg {
            width: 18px;
            height: 18px;
        }
        .popup-body {
            padding: 1rem 1.25rem;
            overflow-y: auto;
        }
        .popup-body.loading {
            text-align: center;
            color: #6b5d4d;
            padding: 2rem;
        }
        .popup-body.error {
            color: #b33;
            text-align: center;
            padding: 1.5rem;
        }
        .ingredient-list {
            list-style: none;
            margin: 0;
            padding: 0;
        }
        .ingredient-list li {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.5rem 0;
            border-bottom: 1px solid #f0ebe3;
        }
        .ingredient-list li:last-child {
            border-bottom: none;
        }
        .ingredient-list .ingredient-icon {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            object-fit: cover;
            flex-shrink: 0;
        }
        .ingredient-list .ingredient-info {
            flex: 1;
            min-width: 0;
        }
        .ingredient-list .ingredient-name {
            font-weight: 500;
            color: #3d3428;
        }
        .ingredient-list .ingredient-amount {
            font-size: 0.9rem;
            color: #6b5d4d;
        }
    </style>
</head>
<body>
    <h1>Рецепты</h1>
    <div class="search-wrap">
        <input type="text" id="search-input" placeholder="Поиск по названию и тегам. Слова через пробел; теги — с # (например: овсянка #завтрак)" autocomplete="off">
    </div>
    <div class="tabs">
        <button type="button" class="tab-btn active" data-tab="breakfast">Завтраки</button>
        <button type="button" class="tab-btn" data-tab="dinner">Обеды и ужины</button>
        <button type="button" class="tab-btn" data-tab="cart">Корзина <span id="cart-count" class="cart-badge" style="display: none;">0</span></button>
    </div>
    <div id="tag-filters" class="tag-filters" style="display: none;">
        <span class="label">Теги:</span>
        <div id="tag-buttons"></div>
    </div>
    <div id="loading">Загрузка рецептов…</div>
    <div id="error" style="display: none;"></div>

    <div id="panel-breakfast" class="tab-panel active">
        <div id="recipes-breakfast" class="recipes" style="display: none;"></div>
    </div>
    <div id="panel-dinner" class="tab-panel">
        <div id="recipes-dinner" class="recipes" style="display: none;"></div>
    </div>
    <div id="panel-cart" class="tab-panel">
        <div id="cart-empty" class="cart-empty" style="display: none;">В корзине пока ничего нет. Нажмите «+» на карточке рецепта, чтобы добавить.</div>
        <div id="recipes-cart" class="recipes" style="display: none;"></div>
    </div>

    <div id="ingredients-popup" class="popup-overlay" aria-hidden="true">
        <div class="popup">
            <div class="popup-header">
                <h3 id="ingredients-popup-title">Ингредиенты</h3>
                <button type="button" class="popup-close" id="ingredients-popup-close" aria-label="Закрыть">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
                </button>
            </div>
            <div id="ingredients-popup-body" class="popup-body">
                Загрузка…
            </div>
        </div>
    </div>

    <script>
        function escapeHtml(s) {
            if (!s) return '';
            var div = document.createElement('div');
            div.textContent = s;
            return div.innerHTML;
        }

        function getRecipeKey(r) {
            var slug = (r.slug || '').trim();
            return slug || (r.name || '').trim() || String(r.id || '');
        }

        function extractNextData(html) {
            var doc = new DOMParser().parseFromString(html, 'text/html');
            var script = doc.getElementById('__NEXT_DATA__');
            if (!script || !script.textContent) return null;
            try {
                return JSON.parse(script.textContent);
            } catch (e) {
                return null;
            }
        }

        function getIngredientsFromNextData(data) {
            try {
                var list = data && data.props && data.props.pageProps && data.props.pageProps.techData && data.props.pageProps.techData.ingredient;
                return Array.isArray(list) ? list : [];
            } catch (e) {
                return [];
            }
        }

        function openIngredientsPopup(recipeName, slug) {
            var overlay = document.getElementById('ingredients-popup');
            var titleEl = document.getElementById('ingredients-popup-title');
            var bodyEl = document.getElementById('ingredients-popup-body');
            titleEl.textContent = recipeName ? 'Ингредиенты: ' + recipeName : 'Ингредиенты';
            bodyEl.className = 'popup-body loading';
            bodyEl.innerHTML = 'Загрузка…';
            overlay.classList.add('active');
            overlay.setAttribute('aria-hidden', 'false');

            var url = 'https://xn--j1agri5c.xn--p1ai/recipes/' + encodeURIComponent(slug);
            fetch(url)
                .then(function (res) { return res.text(); })
                .then(function (html) {
                    var data = extractNextData(html);
                    var ingredients = getIngredientsFromNextData(data);
                    bodyEl.className = 'popup-body';
                    if (ingredients.length === 0) {
                        bodyEl.innerHTML = '<p class="error">Ингредиенты не найдены.</p>';
                        return;
                    }
                    var ul = document.createElement('ul');
                    ul.className = 'ingredient-list';
                    ingredients.forEach(function (ing) {
                        var name = (ing.name || '').trim();
                        var value = ing.value != null ? ing.value : '';
                        var unit = (ing.unit || '').trim();
                        var amount = [value, unit].filter(Boolean).join(' ');
                        var img = ing.icon || ing.image || '';
                        var li = document.createElement('li');
                        if (img) {
                            var imgEl = document.createElement('img');
                            imgEl.src = img;
                            imgEl.alt = '';
                            imgEl.className = 'ingredient-icon';
                            li.appendChild(imgEl);
                        }
                        var info = document.createElement('div');
                        info.className = 'ingredient-info';
                        info.innerHTML = '<span class="ingredient-name">' + escapeHtml(name) + '</span>' +
                            (amount ? '<span class="ingredient-amount">' + escapeHtml(amount) + '</span>' : '');
                        li.appendChild(info);
                        ul.appendChild(li);
                    });
                    bodyEl.innerHTML = '';
                    bodyEl.appendChild(ul);
                })
                .catch(function (err) {
                    bodyEl.className = 'popup-body error';
                    bodyEl.textContent = 'Не удалось загрузить ингредиенты. Проверьте подключение к интернету.';
                });
        }

        function closeIngredientsPopup() {
            var overlay = document.getElementById('ingredients-popup');
            overlay.classList.remove('active');
            overlay.setAttribute('aria-hidden', 'true');
        }

        function renderRecipeCard(r, options) {
            options = options || {};
            var inCart = options.inCart === true;

            var card = document.createElement('div');
            card.className = 'recipe-card';
            card.dataset.recipeKey = getRecipeKey(r);

            var img = r.image_thumb || r.image || '';
            var imgEl = img
                ? '<img src="' + img.replace(/"/g, '&quot;') + '" alt="" loading="lazy">'
                : '';

            var dishName = r.dish && r.dish.name ? r.dish.name : '';
            var time = r.make_time ? r.make_time + ' мин' : '';
            var meta = [dishName, time].filter(Boolean).join(' · ');

            var tagsHtml = '';
            if (r.tag_list && r.tag_list.length) {
                tagsHtml = '<div class="tags">' +
                    r.tag_list.slice(0, 6).map(function (t) {
                        return '<span class="tag">' + escapeHtml(t.name) + '</span>';
                    }).join('') +
                    '</div>';
            }

            var slug = (r.slug || '').trim();
            var recipeUrl = slug ? 'https://кухня.рф/recipes/' + encodeURIComponent(slug) : '#';
            var plusSvg = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>';
            var minusSvg = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><line x1="5" y1="12" x2="19" y2="12"/></svg>';
            var externalSvg = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/></svg>';
            var listSvg = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/><line x1="3" y1="6" x2="3.01" y2="6"/><line x1="3" y1="12" x2="3.01" y2="12"/><line x1="3" y1="18" x2="3.01" y2="18"/></svg>';

            var cartBtnHtml = inCart
                ? '<button type="button" class="btn-icon btn-remove-cart" title="Удалить из корзины" aria-label="Удалить из корзины">' + minusSvg + '</button>'
                : '<button type="button" class="btn-icon btn-add-cart" title="Добавить в корзину" aria-label="Добавить в корзину">' + plusSvg + '</button>';
            var actionsHtml =
                '<div class="card-actions">' +
                cartBtnHtml +
                '<a href="' + escapeHtml(recipeUrl) + '" class="btn-icon" target="_blank" rel="noopener noreferrer" title="Открыть рецепт">' + externalSvg + '</a>' +
                '<button type="button" class="btn-icon btn-ingredients" title="Ингредиенты" aria-label="Ингредиенты">' + listSvg + '</button>' +
                '</div>';

            card.innerHTML =
                (imgEl ? '<div class="img-wrap">' + imgEl + '</div>' : '') +
                '<div class="body">' +
                '<h2>' + escapeHtml(r.name) + '</h2>' +
                (meta ? '<div class="meta">' + escapeHtml(meta) + '</div>' : '') +
                (r.description ? '<p class="description">' + escapeHtml(r.description) + '</p>' : '') +
                tagsHtml +
                actionsHtml +
                '</div>';

            return card;
        }

        function getUniqueTags(recipeList) {
            var byId = {};
            recipeList.forEach(function (r) {
                if (r.tag_list && r.tag_list.length) {
                    r.tag_list.forEach(function (t) {
                        if (t.id && !byId[t.id]) byId[t.id] = { id: t.id, name: t.name };
                    });
                }
            });
            return Object.keys(byId).map(function (id) { return byId[id]; }).sort(function (a, b) {
                return (a.name || '').localeCompare(b.name || '');
            });
        }

        function filterByTags(recipeList, tagIds) {
            if (!tagIds || tagIds.length === 0) return recipeList;
            return recipeList.filter(function (r) {
                if (!r.tag_list || r.tag_list.length === 0) return false;
                return tagIds.every(function (tagId) {
                    return r.tag_list.some(function (t) { return t.id === tagId; });
                });
            });
        }

        function parseSearchQuery(text) {
            var raw = (text || '').trim().split(/\s+/).filter(Boolean);
            var nameWords = [];
            var tagWords = [];
            raw.forEach(function (w) {
                if (w.charAt(0) === '#') {
                    var tag = w.slice(1).trim();
                    if (tag) tagWords.push(tag.toLowerCase());
                } else {
                    if (w) nameWords.push(w.toLowerCase());
                }
            });
            return { nameWords: nameWords, tagWords: tagWords };
        }

        function filterBySearch(recipeList, nameWords, tagWords) {
            if (nameWords.length === 0 && tagWords.length === 0) return recipeList;
            return recipeList.filter(function (r) {
                var name = (r.name || '').toLowerCase();
                var nameMatch = nameWords.length === 0 || nameWords.every(function (w) {
                    return name.indexOf(w) !== -1;
                });
                var tagNames = (r.tag_list || []).map(function (t) { return (t.name || '').toLowerCase(); });
                var tagMatch = tagWords.length === 0 || tagWords.every(function (w) {
                    return tagNames.some(function (t) { return t.indexOf(w) !== -1; });
                });
                return nameMatch && tagMatch;
            });
        }

        var cartRecipes = [];

        function addToCart(r) {
            var key = getRecipeKey(r);
            if (cartRecipes.some(function (x) { return getRecipeKey(x) === key; })) return;
            cartRecipes.push(r);
            updateCartBadge();
            refreshCartPanel();
            var tabId = getCurrentTabId();
            if (tabId === 'breakfast' || tabId === 'dinner') refreshCurrentRecipes();
        }

        function removeFromCart(r) {
            var key = getRecipeKey(r);
            cartRecipes = cartRecipes.filter(function (x) { return getRecipeKey(x) !== key; });
            updateCartBadge();
            refreshCartPanel();
            var tabId = getCurrentTabId();
            if (tabId === 'breakfast' || tabId === 'dinner') refreshCurrentRecipes();
        }

        function updateCartBadge() {
            var el = document.getElementById('cart-count');
            var n = cartRecipes.length;
            el.textContent = n;
            el.style.display = n > 0 ? 'inline-block' : 'none';
        }

        function refreshCartPanel() {
            var panel = document.getElementById('panel-cart');
            if (!panel || !panel.classList.contains('active')) return;
            fillRecipes('recipes-cart', cartRecipes, { inCart: true });
            var emptyEl = document.getElementById('cart-empty');
            var listEl = document.getElementById('recipes-cart');
            if (cartRecipes.length === 0) {
                emptyEl.style.display = 'block';
                listEl.style.display = 'none';
            } else {
                emptyEl.style.display = 'none';
                listEl.style.display = 'grid';
            }
        }

        function isRecipeInCart(r) {
            var key = getRecipeKey(r);
            return cartRecipes.some(function (x) { return getRecipeKey(x) === key; });
        }

        function fillRecipes(containerId, list, options) {
            options = options || {};
            var forceInCart = options.inCart === true;
            var container = document.getElementById(containerId);
            container.innerHTML = '';
            (list || []).forEach(function (r) {
                var inCart = forceInCart || isRecipeInCart(r);
                var card = renderRecipeCard(r, { inCart: inCart });
                container.appendChild(card);
                var addBtn = card.querySelector('.btn-add-cart');
                var removeBtn = card.querySelector('.btn-remove-cart');
                var ingredientsBtn = card.querySelector('.btn-ingredients');
                if (addBtn) {
                    addBtn.addEventListener('click', function () { addToCart(r); });
                }
                if (removeBtn) {
                    removeBtn.addEventListener('click', function () { removeFromCart(r); });
                }
                if (ingredientsBtn) {
                    var slug = (r.slug || '').trim();
                    ingredientsBtn.addEventListener('click', function () {
                        if (!slug) {
                            alert('У рецепта нет ссылки для загрузки ингредиентов.');
                            return;
                        }
                        openIngredientsPopup(r.name, slug);
                    });
                }
            });
            container.style.display = (list && list.length) ? 'grid' : 'none';
        }

        var breakfastList = [];
        var dinnerList = [];
        var selectedTagsByTab = { breakfast: [], dinner: [] };
        var searchQueryText = '';

        function getCurrentTabId() {
            var btn = document.querySelector('.tab-btn.active');
            return btn ? btn.getAttribute('data-tab') : 'breakfast';
        }

        function getFilteredList(tabId) {
            var list = tabId === 'breakfast' ? breakfastList : dinnerList;
            list = filterByTags(list, selectedTagsByTab[tabId] || []);
            var parsed = parseSearchQuery(searchQueryText);
            list = filterBySearch(list, parsed.nameWords, parsed.tagWords);
            return list;
        }

        function refreshCurrentRecipes() {
            var tabId = getCurrentTabId();
            var containerId = tabId === 'breakfast' ? 'recipes-breakfast' : 'recipes-dinner';
            fillRecipes(containerId, getFilteredList(tabId));
        }

        function renderTagFilters(tags, selectedTagIds, onSelect) {
            var wrap = document.getElementById('tag-buttons');
            wrap.innerHTML = '';
            var idSet = {};
            (selectedTagIds || []).forEach(function (id) { idSet[id] = true; });
            tags.forEach(function (tag) {
                var btn = document.createElement('button');
                btn.type = 'button';
                btn.textContent = tag.name;
                btn.dataset.tagId = String(tag.id);
                btn.classList.toggle('active', !!idSet[tag.id]);
                btn.addEventListener('click', function () {
                    var idx = (selectedTagIds || []).indexOf(tag.id);
                    var next = (selectedTagIds || []).slice();
                    if (idx >= 0) next.splice(idx, 1);
                    else next.push(tag.id);
                    next.sort();
                    onSelect(next);
                });
                wrap.appendChild(btn);
            });
        }

        function updateTagFilterButtons(tabId) {
            var list = tabId === 'breakfast' ? breakfastList : dinnerList;
            var selectedTagIds = selectedTagsByTab[tabId] || [];
            var tags = getUniqueTags(list);
            renderTagFilters(tags, selectedTagIds, function (nextTagIds) {
                selectedTagsByTab[tabId] = nextTagIds;
                updateTagFilterButtons(tabId);
                var containerId = tabId === 'breakfast' ? 'recipes-breakfast' : 'recipes-dinner';
                fillRecipes(containerId, getFilteredList(tabId));
            });
        }

        function switchTab(tabId) {
            document.querySelectorAll('.tab-btn').forEach(function (btn) {
                btn.classList.toggle('active', btn.getAttribute('data-tab') === tabId);
            });
            document.querySelectorAll('.tab-panel').forEach(function (panel) {
                panel.classList.toggle('active', panel.id === 'panel-' + tabId);
            });
            if (tabId === 'cart') {
                document.getElementById('tag-filters').style.display = 'none';
                refreshCartPanel();
            } else {
                document.getElementById('tag-filters').style.display = 'flex';
                updateTagFilterButtons(tabId);
                fillRecipes(tabId === 'breakfast' ? 'recipes-breakfast' : 'recipes-dinner', getFilteredList(tabId));
            }
        }

        document.getElementById('search-input').addEventListener('input', function () {
            searchQueryText = this.value;
            refreshCurrentRecipes();
        });

        document.querySelectorAll('.tab-btn').forEach(function (btn) {
            btn.addEventListener('click', function () {
                switchTab(this.getAttribute('data-tab'));
            });
        });

        document.getElementById('ingredients-popup-close').addEventListener('click', closeIngredientsPopup);
        document.getElementById('ingredients-popup').addEventListener('click', function (e) {
            if (e.target === this) closeIngredientsPopup();
        });

        Promise.all([
            fetch('recipes_for_breakfast.json').then(function (res) {
                return res.ok ? res.json() : Promise.reject(new Error('Не удалось загрузить рецепты завтрака'));
            }),
            fetch('recipes_for_dinner.json').then(function (res) {
                return res.ok ? res.json() : Promise.reject(new Error('Не удалось загрузить рецепты ужина'));
            })
        ])
            .then(function (results) {
                document.getElementById('loading').style.display = 'none';
                breakfastList = results[0].recipe_list || [];
                dinnerList = results[1].recipe_list || [];
                document.getElementById('tag-filters').style.display = 'flex';
                selectedTagsByTab = { breakfast: [], dinner: [] };
                updateTagFilterButtons('breakfast');
                document.getElementById('panel-breakfast').classList.add('active');
                fillRecipes('recipes-breakfast', getFilteredList('breakfast'));
                fillRecipes('recipes-dinner', getFilteredList('dinner'));
            })
            .catch(function (err) {
                document.getElementById('loading').style.display = 'none';
                var errEl = document.getElementById('error');
                errEl.style.display = 'block';
                errEl.textContent = err.message || 'Ошибка загрузки';
            });
    </script>
</body>
</html>
