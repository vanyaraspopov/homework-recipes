<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Рецепты</title>
    <style>
        * { box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            margin: 0;
            padding: 1.5rem;
            background: #f5f0ea;
            color: #2c2416;
        }
        h1 {
            text-align: center;
            margin-bottom: 1.5rem;
            color: #5c4a32;
        }
        .tabs {
            display: flex;
            gap: 0;
            max-width: 1200px;
            margin: 0 auto 1.25rem;
            border-bottom: 2px solid #e8e0d5;
        }
        .tabs button {
            padding: 0.65rem 1.5rem;
            font-size: 1rem;
            font-family: inherit;
            color: #6b5d4d;
            background: transparent;
            border: none;
            border-bottom: 3px solid transparent;
            margin-bottom: -2px;
            cursor: pointer;
            transition: color 0.2s, border-color 0.2s;
        }
        .tabs button:hover {
            color: #5c4a32;
        }
        .tabs button.active {
            color: #5c4a32;
            font-weight: 600;
            border-bottom-color: #5c4a32;
        }
        .search-wrap {
            max-width: 1200px;
            margin: 0 auto 1rem;
        }
        .search-wrap input {
            width: 100%;
            padding: 0.65rem 1rem;
            font-size: 1rem;
            font-family: inherit;
            color: #2c2416;
            background: #fff;
            border: 1px solid #ddd5c8;
            border-radius: 8px;
            outline: none;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .search-wrap input:focus {
            border-color: #5c4a32;
            box-shadow: 0 0 0 2px rgba(92, 74, 50, 0.15);
        }
        .search-wrap input::placeholder {
            color: #999;
        }
        .tag-filters {
            max-width: 1200px;
            margin: 0 auto 1rem;
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 0.5rem;
        }
        .tag-filters .label {
            font-size: 0.9rem;
            color: #6b5d4d;
            margin-right: 0.25rem;
        }
        .tag-filters button {
            padding: 0.4rem 0.75rem;
            font-size: 0.85rem;
            font-family: inherit;
            color: #5c4a32;
            background: #e8e0d5;
            border: 1px solid #ddd5c8;
            border-radius: 6px;
            cursor: pointer;
            transition: background 0.2s, border-color 0.2s;
        }
        .tag-filters button:hover {
            background: #ddd5c8;
        }
        .tag-filters button.active {
            background: #5c4a32;
            color: #fff;
            border-color: #5c4a32;
        }
        .tab-panel {
            display: none;
        }
        .tab-panel.active {
            display: block;
        }
        #loading {
            text-align: center;
            padding: 2rem;
            color: #666;
        }
        #error {
            color: #b33;
            padding: 1rem;
            text-align: center;
        }
        .recipes {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 1.25rem;
            max-width: 1200px;
            margin: 0 auto;
        }
        .recipe-card {
            background: #fff;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            transition: box-shadow 0.2s;
        }
        .recipe-card:hover {
            box-shadow: 0 4px 16px rgba(0,0,0,0.12);
        }
        .recipe-card .img-wrap {
            overflow: hidden;
        }
        .recipe-card img {
            width: 100%;
            height: 180px;
            object-fit: cover;
            display: block;
        }
        .recipe-card .body {
            padding: 1rem;
        }
        .recipe-card h2 {
            margin: 0 0 0.5rem;
            font-size: 1.1rem;
            line-height: 1.3;
            color: #3d3428;
        }
        .recipe-card .meta {
            font-size: 0.85rem;
            color: #6b5d4d;
            margin-bottom: 0.5rem;
        }
        .recipe-card .description {
            font-size: 0.9rem;
            color: #555;
            line-height: 1.4;
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        .recipe-card .tags {
            margin-top: 0.75rem;
            display: flex;
            flex-wrap: wrap;
            gap: 0.35rem;
        }
        .recipe-card .tag {
            font-size: 0.75rem;
            background: #e8e0d5;
            color: #5c4a32;
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <h1>Рецепты</h1>
    <div class="search-wrap">
        <input type="text" id="search-input" placeholder="Поиск по названию и тегам. Слова через пробел; теги — с # (например: овсянка #завтрак)" autocomplete="off">
    </div>
    <div class="tabs">
        <button type="button" class="tab-btn active" data-tab="breakfast">Завтраки</button>
        <button type="button" class="tab-btn" data-tab="dinner">Обеды и ужины</button>
    </div>
    <div id="tag-filters" class="tag-filters" style="display: none;">
        <span class="label">Теги:</span>
        <div id="tag-buttons"></div>
    </div>
    <div id="loading">Загрузка рецептов…</div>
    <div id="error" style="display: none;"></div>

    <div id="panel-breakfast" class="tab-panel active">
        <div id="recipes-breakfast" class="recipes" style="display: none;"></div>
    </div>
    <div id="panel-dinner" class="tab-panel">
        <div id="recipes-dinner" class="recipes" style="display: none;"></div>
    </div>

    <script>
        function escapeHtml(s) {
            if (!s) return '';
            var div = document.createElement('div');
            div.textContent = s;
            return div.innerHTML;
        }

        function renderRecipeCard(r) {
            var card = document.createElement('div');
            card.className = 'recipe-card';

            var img = r.image_thumb || r.image || '';
            var imgEl = img
                ? '<img src="' + img.replace(/"/g, '&quot;') + '" alt="" loading="lazy">'
                : '';

            var dishName = r.dish && r.dish.name ? r.dish.name : '';
            var time = r.make_time ? r.make_time + ' мин' : '';
            var meta = [dishName, time].filter(Boolean).join(' · ');

            var tagsHtml = '';
            if (r.tag_list && r.tag_list.length) {
                tagsHtml = '<div class="tags">' +
                    r.tag_list.slice(0, 6).map(function (t) {
                        return '<span class="tag">' + escapeHtml(t.name) + '</span>';
                    }).join('') +
                    '</div>';
            }

            card.innerHTML =
                (imgEl ? '<div class="img-wrap">' + imgEl + '</div>' : '') +
                '<div class="body">' +
                '<h2>' + escapeHtml(r.name) + '</h2>' +
                (meta ? '<div class="meta">' + escapeHtml(meta) + '</div>' : '') +
                (r.description ? '<p class="description">' + escapeHtml(r.description) + '</p>' : '') +
                tagsHtml +
                '</div>';

            return card;
        }

        function getUniqueTags(recipeList) {
            var byId = {};
            recipeList.forEach(function (r) {
                if (r.tag_list && r.tag_list.length) {
                    r.tag_list.forEach(function (t) {
                        if (t.id && !byId[t.id]) byId[t.id] = { id: t.id, name: t.name };
                    });
                }
            });
            return Object.keys(byId).map(function (id) { return byId[id]; }).sort(function (a, b) {
                return (a.name || '').localeCompare(b.name || '');
            });
        }

        function filterByTags(recipeList, tagIds) {
            if (!tagIds || tagIds.length === 0) return recipeList;
            return recipeList.filter(function (r) {
                if (!r.tag_list || r.tag_list.length === 0) return false;
                return tagIds.every(function (tagId) {
                    return r.tag_list.some(function (t) { return t.id === tagId; });
                });
            });
        }

        function parseSearchQuery(text) {
            var raw = (text || '').trim().split(/\s+/).filter(Boolean);
            var nameWords = [];
            var tagWords = [];
            raw.forEach(function (w) {
                if (w.charAt(0) === '#') {
                    var tag = w.slice(1).trim();
                    if (tag) tagWords.push(tag.toLowerCase());
                } else {
                    if (w) nameWords.push(w.toLowerCase());
                }
            });
            return { nameWords: nameWords, tagWords: tagWords };
        }

        function filterBySearch(recipeList, nameWords, tagWords) {
            if (nameWords.length === 0 && tagWords.length === 0) return recipeList;
            return recipeList.filter(function (r) {
                var name = (r.name || '').toLowerCase();
                var nameMatch = nameWords.length === 0 || nameWords.every(function (w) {
                    return name.indexOf(w) !== -1;
                });
                var tagNames = (r.tag_list || []).map(function (t) { return (t.name || '').toLowerCase(); });
                var tagMatch = tagWords.length === 0 || tagWords.every(function (w) {
                    return tagNames.some(function (t) { return t.indexOf(w) !== -1; });
                });
                return nameMatch && tagMatch;
            });
        }

        function fillRecipes(containerId, list) {
            var container = document.getElementById(containerId);
            container.innerHTML = '';
            (list || []).forEach(function (r) {
                container.appendChild(renderRecipeCard(r));
            });
            container.style.display = 'grid';
        }

        var breakfastList = [];
        var dinnerList = [];
        var selectedTagsByTab = { breakfast: [], dinner: [] };
        var searchQueryText = '';

        function getCurrentTabId() {
            var btn = document.querySelector('.tab-btn.active');
            return btn ? btn.getAttribute('data-tab') : 'breakfast';
        }

        function getFilteredList(tabId) {
            var list = tabId === 'breakfast' ? breakfastList : dinnerList;
            list = filterByTags(list, selectedTagsByTab[tabId] || []);
            var parsed = parseSearchQuery(searchQueryText);
            list = filterBySearch(list, parsed.nameWords, parsed.tagWords);
            return list;
        }

        function refreshCurrentRecipes() {
            var tabId = getCurrentTabId();
            var containerId = tabId === 'breakfast' ? 'recipes-breakfast' : 'recipes-dinner';
            fillRecipes(containerId, getFilteredList(tabId));
        }

        function renderTagFilters(tags, selectedTagIds, onSelect) {
            var wrap = document.getElementById('tag-buttons');
            wrap.innerHTML = '';
            var idSet = {};
            (selectedTagIds || []).forEach(function (id) { idSet[id] = true; });
            tags.forEach(function (tag) {
                var btn = document.createElement('button');
                btn.type = 'button';
                btn.textContent = tag.name;
                btn.dataset.tagId = String(tag.id);
                btn.classList.toggle('active', !!idSet[tag.id]);
                btn.addEventListener('click', function () {
                    var idx = (selectedTagIds || []).indexOf(tag.id);
                    var next = (selectedTagIds || []).slice();
                    if (idx >= 0) next.splice(idx, 1);
                    else next.push(tag.id);
                    next.sort();
                    onSelect(next);
                });
                wrap.appendChild(btn);
            });
        }

        function updateTagFilterButtons(tabId) {
            var list = tabId === 'breakfast' ? breakfastList : dinnerList;
            var selectedTagIds = selectedTagsByTab[tabId] || [];
            var tags = getUniqueTags(list);
            renderTagFilters(tags, selectedTagIds, function (nextTagIds) {
                selectedTagsByTab[tabId] = nextTagIds;
                updateTagFilterButtons(tabId);
                var containerId = tabId === 'breakfast' ? 'recipes-breakfast' : 'recipes-dinner';
                fillRecipes(containerId, getFilteredList(tabId));
            });
        }

        function switchTab(tabId) {
            document.querySelectorAll('.tab-btn').forEach(function (btn) {
                btn.classList.toggle('active', btn.getAttribute('data-tab') === tabId);
            });
            document.querySelectorAll('.tab-panel').forEach(function (panel) {
                panel.classList.toggle('active', panel.id === 'panel-' + tabId);
            });
            updateTagFilterButtons(tabId);
            fillRecipes(tabId === 'breakfast' ? 'recipes-breakfast' : 'recipes-dinner', getFilteredList(tabId));
        }

        document.getElementById('search-input').addEventListener('input', function () {
            searchQueryText = this.value;
            refreshCurrentRecipes();
        });

        document.querySelectorAll('.tab-btn').forEach(function (btn) {
            btn.addEventListener('click', function () {
                switchTab(this.getAttribute('data-tab'));
            });
        });

        Promise.all([
            fetch('recipes_for_breakfast.json').then(function (res) {
                return res.ok ? res.json() : Promise.reject(new Error('Не удалось загрузить рецепты завтрака'));
            }),
            fetch('recipes_for_dinner.json').then(function (res) {
                return res.ok ? res.json() : Promise.reject(new Error('Не удалось загрузить рецепты ужина'));
            })
        ])
            .then(function (results) {
                document.getElementById('loading').style.display = 'none';
                breakfastList = results[0].recipe_list || [];
                dinnerList = results[1].recipe_list || [];
                document.getElementById('tag-filters').style.display = 'flex';
                selectedTagsByTab = { breakfast: [], dinner: [] };
                updateTagFilterButtons('breakfast');
                document.getElementById('panel-breakfast').classList.add('active');
                fillRecipes('recipes-breakfast', getFilteredList('breakfast'));
                fillRecipes('recipes-dinner', getFilteredList('dinner'));
            })
            .catch(function (err) {
                document.getElementById('loading').style.display = 'none';
                var errEl = document.getElementById('error');
                errEl.style.display = 'block';
                errEl.textContent = err.message || 'Ошибка загрузки';
            });
    </script>
</body>
</html>
